---
title: "Time to Event Analysis"
author: "Tabitha K. Peter"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE)
```

```{r source_calls}
source("R/R.R")
cmr <- read_csv("data/cmr.csv")
```


```{r data_prep}
# Look at data 
kable(head(cmr),
      digits = 2,
      format = "pipe",
      caption = "Figure 1: A look at the data")


# See what changes we need to make 
dplyr::glimpse(cmr) # notice: lots of options for 'clinic', and some categories are labeled as numbers! 
table(cmr$Clinic, useNA = "always") # hmmm... need to combine some categories 


# Make some formatting changes
cmr <- cmr %>%
  # collapse categories for clinic (we will need this for analysis)
  mutate(Clinic = if_else(Clinic %in% c("ADMS", "CCST", "CODHDG", "FEECLS", 
                                        "GMU", "HDGEN", "HDPROS", "LTDCAR"),
                          "Other",
                          Clinic),
         # tell the computer that some numbers represent *categories* 
         across(.cols = c("No_Surfaces", "RCT", "Status"),
                .fns = as.character),
         # make the IDs have readable names 
         RecordID = paste0("Patient ", RecordID))
```


```{r descriptives}

# Create Table 1 
table1 <- tableby(~ .,
                  data = cmr %>%
                    dplyr::select(-c(RecordID, No_Cases, Tooth_Number,
                                     Date_Repair, End_Date, Failure_Date)),
                  control = tableby.control(
                    test = FALSE
                  )
                  )

# Print out Table 1 in a readable format 
summary(table1) %>% 
  kable(digits = 2,
        format = "pipe",
        caption = "Table 1: Description of Data")





```


```{r timeline}
# Create a timeline chart 
set.seed(52246) # this means the same patients are chosen each time I run this code
example_patients <- sample(1:nrow(cmr), size = 5)

timelines <- ggplot(cmr[example_patients, ], aes(x = RecordID, y = Time)) + 
  geom_col(position = position_dodge(), width = 0.1) +
  geom_point(data = cmr[example_patients, ],
             aes(RecordID, Time, color = Status, shape = Status),
             size = 6) + 
  coord_flip() + 
  theme_minimal() +
  theme(legend.title = element_blank(),
        legend.position = "bottom")

(timelines)

```



```{r km_plot}




```

```{r median_survival}

```

```{r nth_year_survival}

```

```{r cox_model}

```

